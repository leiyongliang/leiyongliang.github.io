var Puzzle=function(t){this._init(t)};Puzzle.prototype={_init:function(t){var e=this;this.leverNow=t.leverNow<=2?2:t.leverNow||2,this.leverArr=[this.leverNow,this.leverNow],this.imgOrigArr=[],this.imgRandomArr=[],this.stepnum=0,this.seconds=null,this.minutes=null,this.btnObj=document.getElementById("btn"),this.main=document.getElementById("main"),this.score_box=document.getElementById("score_box"),this.score=document.getElementById("score"),this.score_ok=document.getElementById("score_ok"),this.scoreNum=0,this.history_score_box=document.getElementById("history_score_box"),this.history_score_btn=document.getElementById("history_score_btn"),this.inputObj=document.getElementById("file"),this.time=document.getElementById("time"),this.timer=null,this.step=document.getElementById("step"),this.imgArea=document.getElementById("imgArea"),this.gameStartBtnObj=document.getElementById("gameStart"),this.gameAreaObj=document.getElementById("gameArea"),this.imgCells="",this.imgAreaWidth=t.imgAreaSize<=400?400:t.imgAreaSize||400,this.imgAreaHeight=t.imgAreaSize<=400?400:t.imgAreaSize||400,this.gameAreaObj.style.width=this.imgAreaWidth+"px",this.gameAreaObj.style.height=this.imgAreaHeight+this.gameStartBtnObj.offsetHeight+30+"px",this.cellWidth=this.imgAreaWidth/this.leverArr[1],this.cellHeight=this.imgAreaHeight/this.leverArr[0],this.hasStart=0,this.sel=null,this.imgUrl="",this.score_ok.onclick=this.score_ok_click(),this.history_score_btn.onclick=this.history_score_box_show(),this.history_score_box.onclick=function(){e.history_score_box.style.display="none"}},gameStart:function(){this.getImageUrl()},getImageUrl:function(){var t=this;this.btnObj.onclick=function(){t.inputObj.click()},this.inputObj.onchange=function(){var e=this.files,i=new FileReader;i.readAsDataURL(e[0]),i.onload=function(){t.imgUrl=i.result,t.imgSplit()}}},imgSplit:function(){this.imgArea.innerHTML="";for(var t="",e=0,i=this.leverArr[0];e<i;e++)for(var r=0,i=this.leverArr[1];r<i;r++)this.imgOrigArr.push(e*this.leverArr[0]+r),t=document.createElement("div"),t.className="imgCell",t.index=e*this.leverArr[0]+r,t.style.width=this.cellWidth+"px",t.style.height=this.cellHeight+"px",t.style.left=r*this.cellWidth+"px",t.style.top=e*this.cellHeight+"px",t.style.backgroundImage="url("+this.imgUrl+")",t.style.backgroundSize=this.leverArr[1]+"00%",t.style.backgroundPosition=-r*this.cellWidth+"px "+-e*this.cellHeight+"px",t.style.backgroundOrigin="border-box",this.imgArea.appendChild(t);this.imgCells=document.querySelectorAll(".imgCell"),this.main.style.left=-this.main.offsetWidth+"px",this.gameAreaObj.style.left="50%",this.gameAreaObj.style.transform="translateX(-50%)",document.body.style.overflowY="auto",this.gameStartBtnObj.onclick=this.clickHandle()},clickHandle:function(){var t=this;return function(){if(0==t.hasStart){clearInterval(t.timer),t.stepnum=0,t.step.innerHTML=0,t.timeStart(),t.hasStart=1,t.randomArr(),t.cellOrder();for(var e=0,i=t.imgCells.length;e<i;e++)t.imgCells[e].onclick=function(){if(null===t.sel)t.sel=this.index,this.style.border="2px solid red";else{if(t.imgCells.forEach(function(t){t.style.border="1px solid #fff"}),this.index===t.sel)return void(t.sel=null);t.cellExchange(t.sel,this.index),t.sel=null}}}}},score_ok_click:function(){var t=this;return function(){t.score_box.style.display="none";var e=JSON.parse(localStorage.getItem("scoreList"))||[];e.push(Math.round(t.scoreNum)),localStorage.setItem("scoreList",JSON.stringify(e))}},history_score_box_show:function(){var t=this;return function(){t.history_score_box.innerHTML="",t.history_score_box.style.display="block";var e=JSON.parse(localStorage.getItem("scoreList"))||[];e.sort(function(t,e){return e-t});if(e.length)for(var i=0;i<e.length;i++){var r=document.createElement("div");r.setAttribute("class","history_score_item"),r.innerHTML="<div>"+(i+1)+"</div><div>"+e[i]+"</div>",t.history_score_box.appendChild(r)}else t.history_score_box.innerHTML="暂时没有成绩记录，快去玩一局吧"}},timeStart:function(){var t=this,e=(new Date).getTime();this.timer=setInterval(function(){var i=(new Date).getTime()-e,r=(Math.floor(i/864e5),i%864e5),s=(Math.floor(r/36e5),r%36e5),l=Math.floor(s/6e4),n=s%6e4,o=Math.round(n/1e3);t.seconds=o,t.minutes=l,l?t.time.innerHTML=l+"分 "+o+"秒":t.time.innerHTML=o+"秒"},1e3)},randomArr:function(){this.imgRandomArr=[];for(var t=!0,e=0,i=this.imgOrigArr.length;e<i;e++){var r=Math.floor(Math.random()*this.imgOrigArr.length);if(this.imgRandomArr.length>0)for(;this.imgRandomArr.indexOf(r)>-1;)r=Math.floor(Math.random()*this.imgOrigArr.length);this.imgRandomArr.push(r)}if(this.imgRandomArr.length===this.imgOrigArr.length)for(var e=0,i=this.imgOrigArr.length;e<i;e++){if(this.imgRandomArr[e]!=this.imgOrigArr[e]){t=!1;break}t=!0}else t=!0;t&&this.randomArr()},cellOrder:function(){var t=this;this.imgCells.forEach(function(e,i){e.style.left=t.imgRandomArr[i]%t.leverArr[1]*t.cellWidth+"px",e.style.top=Math.floor(t.imgRandomArr[i]/t.leverArr[1])*t.cellHeight+"px"})},cellExchange:function(t,e){var i=Math.floor(this.imgRandomArr[t]/this.leverArr[1]),r=this.imgRandomArr[t]%this.leverArr[1],s=Math.floor(this.imgRandomArr[e]/this.leverArr[1]),l=this.imgRandomArr[e]%this.leverArr[1];this.imgCells[t].style.left=l*this.cellWidth+"px",this.imgCells[t].style.top=s*this.cellHeight+"px",this.imgCells[e].style.left=r*this.cellWidth+"px",this.imgCells[e].style.top=i*this.cellHeight+"px";var n=this.imgRandomArr[t];this.imgRandomArr[t]=this.imgRandomArr[e],this.imgRandomArr[e]=n,this.stepnum+=1,this.step.innerHTML=this.stepnum,this.imgOrigArr.toString()===this.imgRandomArr.toString()&&this.success()},success:function(){var t=this;this.scoreNum=60/(60*this.minutes+this.seconds)/this.stepnum*1e3,clearInterval(this.timer),this.hasStart=0;var e=0;setTimeout(function(){t.score_box.style.display="block";var i=setInterval(function(){e<=t.scoreNum?(t.score.innerHTML=e,e+=1):clearInterval(i)},4)},600)}};